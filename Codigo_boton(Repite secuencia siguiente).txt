; CODIGO CON BOTON (pero repite la secuencia siguiente)
#include <xc.inc>

; Config bits
CONFIG  FOSC = INTOSCIO_EC
CONFIG  WDT  = OFF
CONFIG  LVP  = OFF
CONFIG  PBADEN = OFF

; Reset
PSECT  resetVec, class=CODE, reloc=2
ORG     0x00
GOTO    Main

; Variables
PSECT  udata
Cont1:  DS 1
Cont2:  DS 1
Cont3:  DS 1
Secuencia:  DS 1      ; 0..2
Rotar:      DS 1      ; 0=no, 1=s√≠ 

; Definicion de codigo
PSECT  main_code, class=CODE, reloc=2
Main:
    ; OSCCON ~8 MHz 
    MOVLW   0b01110110
    MOVWF   OSCCON

    ;definimos a  
      ;RB0:RB3 salidas
      ;RB4:RB7 entradas
    MOVLW   0xF0
    MOVWF   TRISB
    CLRF    LATB
    
    
    CLRF    Secuencia
    CLRF    Rotar
    
    

MainLoop:
    
    CALL    LeeBoton  ;Rotar=1 si el boton esta presionado RB4=0.
                      ;Primero se lee al inicio del ciclo.
		     
    ;posteriormente se ejecuta un bloque visible de la secuencia actual:
    CALL    EjecutaSecuencia
    
    ;Decision que se toma con el estado de "Rotar" al inicio del bloque:
     MOVF    Rotar, W
     BZ      NoRotate
     INCF    Secuencia, F
     MOVLW   3
     CPFSLT  Secuencia
     CLRF    Secuencia
 NoRotate:
    GOTO    MainLoop
    
    
    ;BOTON EN RB4
    LeeBoton:
    
     ;primera lectura:
    BTFSC   PORTB, 4           ;Si RB4==0(presionado), se salta el goto
			       ;Si RB4==1(suelto), ejecuta el goto
                               
    GOTO    LBNP_1
    
    
    CALL    Delay_5ms          ;Antirrebote
    
     ;segunda lectura:
    BTFSC   PORTB, 4           ;Si RB4==0(presionado), se salta el goto
			       ;Si RB4==1(suelto), ejecuta el goto  
    
    GOTO    LBNP_1
    
    
    ;Ambas lecturas confirmaron que el boton estaba "presionado". 
    MOVLW   1
    MOVWF   Rotar    ;Rotar= 1, se considera presionado.
    RETURN
    
    
  ;Caso contrario, es decir que el boton se considera como "no presionado".
LBNP_1:
    CLRF    Rotar    ;Rotar=0.
    RETURN

    
    
   ;MULTIPLEXOR de secuencias (ejecuta 1 bloque) 
EjecutaSecuencia:
    MOVF    Secuencia, W
    BZ      Secuencia1
    DECF    WREG, W
    BZ      Secuencia2
    GOTO    Secuencia3
    
    ;BSF     LATB, 0         ; Enciende RB0
    ;CALL    Delay_200ms
    ;BCF     LATB, 0         ; Apaga RB0
    ;CALL    Delay_200ms
    ;GOTO    MainLoop
    
    
    
      ;DEFINIMOS SECUENCIA 1 (alternancia de pares)
     Secuencia1:
     MOVLW   0x05          ; RB0 y RB2
     MOVWF   LATB
     CALL    Delay_200ms
     MOVLW   0x0A          ; RB1 y RB3
     MOVWF   LATB
     CALL    Delay_200ms
     RETURN
      
      
      ;DEFINIMOS SECUENCIA 2 (un solo led a la vez)
    Secuencia2:
    MOVLW   0x01
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x02
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x04
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x08
    MOVWF   LATB
    CALL    Delay_200ms
    RETURN

      ;Definimos SECUENCIA 3 (todos los leds se prenden en secuencia)
    Secuencia3:
    MOVLW   0x01
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x03
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x07
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x0F
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x07
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x03
    MOVWF   LATB
    CALL    Delay_200ms
    MOVLW   0x01
    MOVWF   LATB
    CALL    Delay_200ms
    RETURN
    
    
;parte del (PRIMER) codigo:     
; Retardos
Delay_200ms:
    MOVLW   40
    MOVWF   Cont1
D200:
    CALL    Delay_5ms
    DECFSZ  Cont1, F
    GOTO    D200
    RETURN

Delay_5ms:
    MOVLW   250
    MOVWF   Cont2
D5:
    CALL    Delay_20us
    DECFSZ  Cont2, F
    GOTO    D5
    RETURN

Delay_20us:
    MOVLW   25
    MOVWF   Cont3
D20:
    NOP
    NOP
    NOP
    NOP
    DECFSZ  Cont3, F
    GOTO    D20
    RETURN

END
